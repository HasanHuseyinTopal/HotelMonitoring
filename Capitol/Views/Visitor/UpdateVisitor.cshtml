@using EntityLayer.Entities
@model UpdateVisitorDTO

<div class="col-5 container border shadow p-2 mt-3">
    <section class="container">
        <header style="font-weight: 600; color: #202040;">Ziyaretçi Güncelleme Formu</header>
        <form id="formRegister" asp-controller="Visitor" asp-action="UpdateVisitor" method="post" class="form">
            <input id="visitorIdInput" hidden asp-for="VisitorId" />
            <input hidden asp-for="VisitorState" />
            <input hidden asp-for="VisitorPaymentIsDone" />
            <input hidden name="previusUrl" value="@ViewBag.previusUrl" />
            <div class="column">
                <div class="input-box">
                    <label asp-for="VisitorName">Adı</label>
                    <input style="border:2px solid red; box-shadow:2px 2px 6px black;" type="text" asp-for="VisitorName" placeholder="Adını giriniz" autocomplete="off">
                </div>
                <div class="input-box">
                    <label asp-for="VisitorSurName">Soyadı</label>
                    <input type="text" asp-for="VisitorSurName" placeholder="Soyadını giriniz" autocomplete="off" />
                </div>
                <div class="input-box">
                    <label asp-for="VisitorRoomNumber">Oda Numarası</label>
                    <div class="column">
                        <div class="select-box">
                            <select id="RoomNumber" style="border:2px solid red; box-shadow:2px 2px 6px black; border-radius:6px;" asp-for="VisitorRoomNumber">
                                @if (ViewBag.Blokaj != null)
                                {
                                    <option selected>@ViewBag.Blokaj</option>
                                }
                                else
                                {
                                    <option selected disabled hidden>Oda Numarası</option>
                                    <option>101</option>
                                    <option>102</option>
                                    <option>103</option>
                                    <option>104</option>
                                    <option>201</option>
                                    <option>202</option>
                                    <option>203</option>
                                    <option>204</option>
                                    <option>301</option>
                                    <option>302</option>
                                    <option>303</option>
                                    <option>304</option>
                                    <option>401</option>
                                    <option>402</option>
                                    <option>403</option>
                                    <option>404</option>
                                    <option>501</option>
                                    <option>502</option>
                                    <option>503</option>
                                    <option>601</option>
                                    <option>602</option>
                                    <option>603</option>
                                    <option>701</option>
                                    <option>702</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column">
                <div class="input-box">
                    <label for="CheckInDate" asp-for="VisitorStartDate">Giriş Tarihi</label>
                    <input id="CheckInDate" style="border:2px solid red; box-shadow:2px 2px 6px black;" type="date" asp-for="VisitorStartDate" autocomplete="off" required />
                </div>
                <div class="input-box">
                    <label for="CheckOutDate" asp-for="VisitorEndDate">Çıkış Tarihi</label>
                    <input id="CheckOutDate" style="border:2px solid red; box-shadow:2px 2px 6px black;" type="date" asp-for="VisitorEndDate" autocomplete="off" required />
                </div>
            </div>
            <div class="column">
                <div class="input-box">
                    <label asp-for="VisitorRezervation">Rezervazyon Tipi</label>
                    <div class="column">
                        <div class="select-box">
                            <select asp-for="VisitorRezervation" asp-items="@Html.GetEnumSelectList<Rezervation>()">
                                <option selected disabled hidden>Rezervasyon</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="input-box">
                    <label asp-for="VisitorPhoneNumber">Telefon Numarası</label>
                    <input type="tel" asp-for="VisitorPhoneNumber" placeholder="Telefon numarası giriniz" autocomplete="off" />
                </div>
                <div style="width:250px;" class="input-box">
                    <label asp-for="VisitorCount">Kişi Sayısı</label>
                    <div class="column">
                        <div class="select-box">
                            <select asp-for="VisitorCount">
                                <option selected disabled hidden>Adet</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column">
                <div style="width:100px" class="input-box">
                    <label for="DoPayment">Ödeme</label>
                    <input type="checkbox" id="DoPayment" name="DoPayment" value="true" />
                </div>
                <div class="input-box">
                    <label asp-for="VisitorRoomPrice">Oda Fiyatı</label>
                    <input type="number" step="any" asp-for="VisitorRoomPrice" placeholder="Oda fiyatını giriniz" autocomplete="off" />
                </div>
                <div class="input-box">
                    <label asp-for="VisitorPaymentCurrency">Para Birimi</label>
                    <div class="column">
                        <div class="select-box">
                            <select asp-for="VisitorPaymentCurrency" asp-items="@Html.GetEnumSelectList<Currency>()">
                                <option selected disabled hidden>Para Birimi</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-box">
                <label style="display:block" asp-for="VisitorDescription">Not</label>
                <textarea asp-for="VisitorDescription" placeholder="..." autocomplete="off"></textarea>
            </div>
            <button>Güncelle</button>
            <div class="position-absolute d-flex text-danger p-3" style="top:150px; left:150px;" asp-validation-summary="All"></div>
        </form>
    </section>

</div>


@section Scripts{
    <partial name="_ValidationScriptsPartial.cshtml" />
    <script>
        async function FetchApi(url) {
            let data = await fetch(url).then(data => data.json())
            return data;
        }
        var newCheckInDateControl = new Date(new Date(document.getElementById("CheckInDate").value).getFullYear(), new Date(document.getElementById("CheckInDate").value).getMonth() + 1, new Date(document.getElementById("CheckInDate").value).getDate()).getTime()
        var newCheckOutDateControl = new Date(new Date(document.getElementById("CheckOutDate").value).getFullYear(), new Date(document.getElementById("CheckOutDate").value).getMonth() + 1, new Date(document.getElementById("CheckOutDate").value).getDate()).getTime()
        var newRoomNumberControl = document.getElementById("RoomNumber").value;

        var form = document.getElementById("formRegister");
        form.addEventListener("submit", function (e) {
            var name = $("input[name='VisitorName']").val()
            var roomnumber = $("select[name='VisitorRoomNumber']").val()
            var startdate = $("input[name='VisitorStartDate']").val()
            var enddate = $("input[name='VisitorEndDate']").val()
            if (name && roomnumber && startdate && enddate) {
                if ($("#DoPayment").is(':checked') != true) {
                    e.preventDefault();
                    FetchApi("https://localhost:7121/Visitor/CheckForCrashDate").then(visitors => {
                        if (visitors.length <= 0) {
                            form.submit();
                        }
                        let checkState = true;
                        visitors.forEach((visitor, index) => {
                            let roomNumber = document.getElementById("RoomNumber").value;

                            var visitorCheckInDate = new Date(new Date(visitor.visitorStartDate).getFullYear(), new Date(visitor.visitorStartDate).getMonth() + 1, new Date(visitor.visitorStartDate).getDate()).getTime()

                            var visitorCheckOutDate = new Date(new Date(visitor.visitorEndDate).getFullYear(), new Date(visitor.visitorEndDate).getMonth() + 1, new Date(visitor.visitorEndDate).getDate()).getTime()

                            var newCheckInDate = new Date(new Date(document.getElementById("CheckInDate").value).getFullYear(), new Date(document.getElementById("CheckInDate").value).getMonth() + 1, new Date(document.getElementById("CheckInDate").value).getDate()).getTime()

                            var newCheckOutDate = new Date(new Date(document.getElementById("CheckOutDate").value).getFullYear(), new Date(document.getElementById("CheckOutDate").value).getMonth() + 1, new Date(document.getElementById("CheckOutDate").value).getDate()).getTime()


                            if (newCheckInDateControl == newCheckInDate && newCheckOutDateControl == newCheckOutDate && roomNumber == newRoomNumberControl) {
                                form.submit();
                                console.log("Not Changed")
                            }

                            else if (visitor.visitorRoomNumber == roomNumber && visitor.visitorCount <= 1 && visitors.length > 1 && $("#visitorIdInput").val() != visitor.visitorId) {

                                if ((newCheckInDate >= visitorCheckInDate && newCheckOutDate <= visitorCheckOutDate) || (newCheckInDate <= visitorCheckInDate && newCheckOutDate >= visitorCheckOutDate) || newCheckInDate == visitorCheckInDate || newCheckOutDate == visitorCheckOutDate || (newCheckInDate > visitorCheckInDate && newCheckInDate < visitorCheckOutDate) || (newCheckOutDate > visitorCheckInDate && newCheckOutDate < visitorCheckOutDate)) {
                                    console.log("try")
                                    checkState = false;
                                    Swal.fire({
                                        title: 'Oda bu tarihlerde dolu?',
                                        text: "Hatırlatma",
                                        icon: 'warning',
                                        showCancelButton: true,
                                        confirmButtonColor: '#3085d6',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: 'Evet, Onayla',
                                        cancelButtonText: 'İptal',
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            Swal.fire(
                                                'Onaylandi!',
                                                '',
                                                'success',
                                                setTimeout(() => {
                                                    form.submit();
                                                    console.log("error")
                                                }, 500)
                                            )
                                        }
                                    })
                                }
                            } if (index == (visitors.length - 1) && checkState) {
                                form.submit();
                                console.log("Done")
                            }
                        })
                    })
                }
            }
        })
    </script>
}

